---
params:
  title: tom tittel
  author: ukjent forfatter
  hospitalName: ukjent sykehus
  tableFormat: html
  reshId: 999999
  registryName: rapbase
  userFullName: Tore Tester
  userRole: ukjent rolle
  userOperator: ukjent operatør
header-includes:
- \usepackage[english, norsk]{babel}
- \usepackage{booktabs}
- \usepackage{rotating}
- \usepackage{float}
title: |  
  | Nasjonalt register for ablasjonsbehandling og elektrofysiologi i Norge (AblaNor)
  |
  | __`r paste0("Månedsrapport for ", params$hospitalName)`__
  |
  |
abstract: '`r paste0("Denne rapporten oppsummerer nøkkeltall for registreringer i AblaNor utført av ",  params$hospitalName, " for hele fjorårets registreringer samt alle fullførte måndeder hittil i år.  Bare forløp som har resultert i en prosedyre, eventuelt en avbrutt en, teller med i datagrunnlaget. Opptellingene er gjort per forløp i perioden, det vil si at en pasient som har hatt mer enn et forløp vil telle flere ganger.") `'
date: '`r format(Sys.time(), "%d. %B, %Y")`'
registryName: '`r params$registryName`'
reglogo: '`r system.file("logoAblanor.png", package = "ablanor")`'
regtext: '`r readLines(system.file("registryShortDescription.txt", package = "ablanor"))`'
userFullName: '`r params$userFullName`'
linkcolor: darkblue
output:
  fig_caption: yes
---


```{r knitrOptions, include=FALSE}
library(ablanor)
library(magrittr)
library(knitr)
library(kableExtra)
library(dplyr)
library(tidyr)
library(ggplot2)

# make sure to use a temporary directory AND absolute paths, e.g. that figs
# can be found also when deployed at a server. See below link for explanation
# https://rgriff23.github.io/2017/04/25/how-to-knit-for-mysite.html
# Also make sure we use tempdir() as working directory so we do not clutter
# the package of the hosting shiny app
# workDir <- tempdir()
# knitr::opts_knit$set(base.dir=workDir, base.url=file.path(paste0(tempdir(), "/")), root.dir = workDir)

# Handle both html and latex (pdf) output. Actually to avoid setting 'format'
# for each kable call
# inspired by https://stackoverflow.com/questions/46080853/why-does-rendering-a-pdf-from-rmarkdown-require-closing-rstudio-between-renders
options(knitr.table.format = params$tableFormat)
knitr::opts_chunk$set(warnings = FALSE, echo = FALSE)
options(stringsAsFactors = FALSE)

# For some reason Shiny Server does not get the server locale settings right.
# To display dates correct, enforce locale here:
Sys.setlocale("LC_TIME", "nb_NO.UTF-8")
``` 




```{r SKDEcol, include=FALSE}
colPrimary <- c("#000059", "#084594", "#2171b5", "#4292c6", "#6baed6", "#c6dbef")
colNeutral <- c("#4D4D4D", "#737373", "#A6A6A6", "#DADADA")
colKontrast <- "#FF7260"
```

```{r parametre}
showN <- 12

#Egendefinerte kortnavn:
hospitalNameShort <- ablanor::getHospitalName(reshId = params$reshId, 
                                              shortName = TRUE,
                                              newNames = TRUE)
```


```{r latest_entry, include=FALSE, eval=TRUE}

# DATAGRUNNLAG: PERIODE

# NYESTE DATO: 
# Finne nyeste prosedyredato i prosedyre-tabellen. Vi ønsker ikke at 
# forhåndsregisrerte planlagte forløp kommer med i rapporten. Derfor brukes
# gårsdagens dato som referanse, ingen forløp etter denne kommer med .  
# Vi vil dermed også kunne se dersom ingen nye registreringer gjøres eller om
# overføringer har stoppet opp

# ELDSTE DATO: 
# Januar fra i fjor (hele foregående år skal vise i rapporten)

# nyeste_reg <- ablanor::getLatestEntry()
nyeste_reg <- min(
  (as.Date(Sys.time()-1)),
  ablanor::getLatestEntry())

# periode_data <- data.frame(
#   siste_dato = min((as.Date(Sys.time()) - 1), 
#                    nyeste_reg)) %>% 
#   dplyr::mutate(forste_dato  = lubridate::floor_date(.data$siste_dato, 
#                                                      "month") - months(showN))

periode_data <- data.frame(nyeste_reg = nyeste_reg) %>% 
  dplyr::mutate(
    
    # SISTE DATO AVGJØR SISTE MÅNED: 
    siste_dato_innevarende_mnd = lubridate::ceiling_date(
      x = nyeste_reg, unit =  "month") - lubridate::days(1),
    
    siste_dato = dplyr::case_when(
      # siste dato er nyeste dato --> nyeste mnd er komlett
      siste_dato_innevarende_mnd == nyeste_reg ~ 
        nyeste_reg, 
      
      # siste dato er ikke nyeste --> nyest mnd er ikke komplett, ta forrige
      siste_dato_innevarende_mnd != nyeste_reg ~ 
        lubridate::floor_date(nyeste_reg, "month") - 
        lubridate::days(1), 
      
      TRUE ~ as.Date(NA_character_)),

    # Inneværende år: 
    nyesteRegYear = as.numeric(format(siste_dato, format = "%Y")),
    
    # Fjoråret
    sisteHeleYear = nyesteRegYear - 1, 
    
    # Inneværende måned i år: 
    nyesteRegMnd = as.numeric(format(siste_dato, format = "%m")),
    
    # Første dato for SQL -spørring : 01. januar fjoråret
    forste_dato  = as.Date(paste0(sisteHeleYear, "-01-01"),
                           format = "%Y-%m-%d")
  ) %>% 
  dplyr::select(-siste_dato_innevarende_mnd)

```

<!-- ```{r monthTabPrepare, include=FALSE, eval=TRUE} -->

<!-- timeTableMonth <- data.frame( -->
<!--   monthDato = seq(periode_data$forste_dato,  -->
<!--                   periode_data$siste_dato, -->
<!--                   by = "month")) %>%  -->
<!--   dplyr::transmute(maaned = as.factor(format(x = monthDato,  -->
<!--                                              format = "%Y-%m"))) %>%  -->
<!--   dplyr::mutate(maaned = as.ordered(maaned)) -->


<!-- timeTableMonth_fjor <- data.frame( -->
<!--   monthDato = seq(periode_data$forste_dato,  -->
<!--                   as.Date(paste("30-12-", periode_data$sisteHeleYear),  -->
<!--                           format = "%d-%m-%Y"), -->
<!--                   by = "month")) %>%  -->
<!--   dplyr::transmute(maaned = as.factor(format(x = monthDato,  -->
<!--                                              format = "%Y-%m"))) %>%  -->
<!--   dplyr::transmute( -->
<!--     maaned = as.ordered(maaned)) -->

<!-- timeTableMonth_aar <- data.frame( -->
<!--   monthDato = seq(as.Date(paste("01-01-", periode_data$nyesteRegYear),  -->
<!--                           format = "%d-%m-%Y"), -->
<!--                   periode_data$siste_dato, -->
<!--                   by = "month")) %>%  -->
<!--   dplyr::transmute(maaned = as.factor(format(x = monthDato,  -->
<!--                                              format = "%Y-%m"))) %>%  -->
<!--   dplyr::transmute( -->
<!--     maaned = as.ordered(maaned)) -->



<!-- rangeProsDato <- paste(format(periode_data$forste_dato,  -->
<!--                               "%d/%m-%Y"),  -->
<!--                        "til",  -->
<!--                        format(periode_data$siste_dato,  -->
<!--                               "%d/%m-%Y")) -->

<!-- siste_dato_txt <- format(x = periode_data$siste_dato, -->
<!--                          format = "%d/%m-%Y") -->
<!-- ``` -->


```{r GetData, include=FALSE, warning=FALSE, cache=FALSE}
# Fjernes når alle fig og tab bruker nasjonal database
d_ablanor <- ablanor::getBaseregProsData(singleRow = FALSE, 
                                         reshId = params$reshId,
                                         userRole = params$userRole, 
                                         fromDate = periode_data$forste_dato, 
                                         toDate = periode_data$siste_dato)



d_ablanor_nasjonalt <- ablanor::getBaseregProsData(singleRow = FALSE, 
                                                   reshId = params$reshId,
                                                   userRole = "SC", 
                                                   fromDate = periode_data$forste_dato, 
                                                   toDate = periode_data$siste_dato)

tab_list_hendelse_nasjonalt <- ablanor::getHendelse(singleRow = FALSE, 
                                                     reshId = params$reshId,
                                                     userRole = "SC", 
                                                     fromDate = NULL, 
                                                     toDate = NULL)


d_hendelse_nasjonalt <- tab_list_hendelse_nasjonalt$d_hendelse %>% 
      dplyr::rename_at(dplyr::vars(KOMP_JANEI:STATUS),
                       function(x) {
                         paste0("adhoc_", x)
                       }) %>%
      dplyr::rename("MCEID_adhoc" = "MCEID") %>%
      dplyr::select(MCEID_adhoc,
                    CENTREID,
                    DATO_ADHOC,
                    adhoc_KOMP_JANEI:adhoc_STATUS)


tab_list_basereg_nasjonalt <- ablanor::getBasereg(singleRow = FALSE, 
                                           reshId = params$reshId,
                                           userRole = "SC", 
                                           fromDate = periode_data$forste_dato, 
                                           toDate = periode_data$siste_dato)

d_basereg_nasjonalt <- tab_list_basereg_nasjonalt$d_basereg %>% 
  dplyr::select(MCEID, CENTREID, HOYDE, VEKT)

tab_list_pros_nasjonalt <- ablanor::getPros(singleRow = FALSE, 
                                            reshId = params$reshId,
                                            userRole = "SC", 
                                            fromDate = periode_data$forste_dato, 
                                            toDate = periode_data$siste_dato)

d_pros_nasjonalt <- tab_list_pros_nasjonalt$d_pros %>% 
  dplyr::select(MCEID, CENTREID, FORLOPSTYPE, DATO_PROS)


tab_list_mce_nasjonalt <- ablanor::getMce(singleRow = FALSE, 
                                          reshId = params$reshId,
                                          userRole = "SC", 
                                          fromDate = periode_data$forste_dato, 
                                          toDate = periode_data$siste_dato)

d_mce_nasjonalt <- tab_list_mce_nasjonalt$d_mce %>% 
  dplyr::select(MCEID, CENTREID, MCETYPE, PARENTMCEID)


names(d_hendelse_nasjonalt) <- tolower(names(d_hendelse_nasjonalt))
names(d_basereg_nasjonalt) <- tolower(names(d_basereg_nasjonalt))
names(d_pros_nasjonalt) <- tolower(names(d_pros_nasjonalt))
names(d_mce_nasjonalt) <- tolower(names(d_mce_nasjonalt))

d_hendelse_nasjonalt %<>% dplyr::left_join(.,
                                     d_mce_nasjonalt %>% 
                                       dplyr::filter(mcetype == 8) %>%
                                       dplyr::select(mceid, parentmceid) %>%
                                       dplyr::rename(mceid_adhoc = mceid,
                                                     mceid = parentmceid),
                                     by = "mceid_adhoc")

# Legg til hendelse i pasient - prosedyre - data
d_ablanor_hendelse_nasjonalt <-  dplyr::right_join(
  x = dplyr::left_join(d_basereg_nasjonalt, d_pros_nasjonalt, by = c("mceid", "centreid")),
  y = d_hendelse_nasjonalt,
  by = c("mceid", "centreid")) %>%
  
  # Antall dager fra prosedyre til hendelse
  dplyr::mutate(dager_pros_hendelse = as.numeric(difftime(
    dato_adhoc,
    dato_pros,
    units = "days"
  )))


d_ablanor_hendelse_nasjonalt %<>% filter(
  dato_pros >= periode_data$forste_dato,
  dato_pros <= periode_data$siste_dato)


```

```{r forste_siste_registrering_SHUS}

# Fjernes når alle fig og tab bruker nasjonal database
periode_data$forste_dato_shus <- d_ablanor %>% 
  dplyr::summarise(min(.data$dato_pros)) %>% 
  dplyr::pull()

periode_data$nyeste_dato_shus <- d_ablanor %>% 
  dplyr::summarise(max(.data$dato_pros)) %>% 
  dplyr::pull()




periode_data$forste_dato_shus <- d_ablanor_nasjonalt %>% 
  dplyr::summarise(min(.data$dato_pros)) %>% 
  dplyr::pull()

periode_data$nyeste_dato_shus <- d_ablanor_nasjonalt %>% 
  dplyr::summarise(max(.data$dato_pros)) %>% 
  dplyr::pull()

```


```{r Oppdatere_levels}

# OPPDATERE : UKE, MÅNED, ÅR for å få riktig levels i faktorer, også dersom 
# ingen registreringer i løpet av en måned

# Fjernes når alle fig og tab bruker nasjonal database
d_ablanor %<>%
  dplyr::mutate(
    aar = as.ordered(lubridate::year(.data$dato_pros)),
    maaned = as.ordered(format(.data$dato_pros, "%Y-%m"))
  )

d_ablanor_nasjonalt %<>%
  dplyr::mutate(
    aar = as.ordered(lubridate::year(.data$dato_pros)),
    maaned = as.ordered(format(.data$dato_pros, "%Y-%m"))
  )


d_ablanor_hendelse_nasjonalt %<>%
  dplyr::mutate(
    aar = as.ordered(lubridate::year(.data$dato_pros)),
    maaned = as.ordered(format(.data$dato_pros, "%Y-%m"))
  )

# OPPDATERE ALLE ANDRE FAKTOR variabler, for å få med alle mulige nivåer

# Fjernes når alle fig og tab bruker nasjonal database
d_ablanor %<>%
  dplyr::mutate(forlopstype = factor(x = forlopstype,
                                     levels = 1:4))

d_ablanor_nasjonalt %<>%
  dplyr::mutate(forlopstype = factor(x = forlopstype,
                                     levels = 1:4),
                
                forlopstype_med_AVknute = factor(
                  x = dplyr::case_when(
                    (abla_strat_av_his %in% 0 & forlopstype %in% 1) ~ "AFLI (uten AV-knute)",
                    forlopstype %in% 2 ~ "VT",
                    (abla_strat_av_his %in% 0 & forlopstype %in% 3) ~ "SVT (uten AV-knute)",
                    forlopstype %in% 4 ~ "EFU",
                    (abla_strat_av_his %in% 1 & forlopstype %in% c(1,3)) ~ "AV-knute (AFLI eller SVT)",
                    TRUE ~ NA_character_),
                  levels = c("AFLI (uten AV-knute)",
                             "VT",
                             "SVT (uten AV-knute)",
                             "EFU",
                             "AV-knute (AFLI eller SVT)")
                ))

```


# Datagrunnlag 
Datagrunnlaget for denne rapporten er hele fjorårets registreringer samt alle fullførte måndeder hittil i år i AblaNor, det vil si i perioden 
`r format(periode_data$forste_dato , "%d/%m-%Y")` til
`r format(periode_data$siste_dato, "%d/%m-%Y")`. 


Første og siste registrering fra `r hospitalNameShort` i tidsperioden er
henholdsvis `r format(periode_data$forste_dato_shus, "%d/%m-%Y") ` og
`r format(periode_data$nyeste_dato_shus, "%d/%m-%Y") `. 



`r if(params$tableFormat !="pdf") {"<!--"}`
\newpage
`r if(params$tableFormat !="pdf") {"-->"}`

# Forløpstype
Forløpene i registrert i AblaNor er en av typene : Atrieflimmer/atypisk flutter
(AFLI), Ventrikkeltakykardi (VT), Supraventrikulær takykardi (SVT) eller 
Elektrofysiologisk undersøkelse (EFU).

Tabellen under (Tabell \@ref(tab:typeForlopAar)) viser antall forløp
registrert i AblaNor for siste hele år samt alle fullførte måneder 
hittil i år fra `r hospitalNameShort` og nasjonalt, for hver forløpstype og sammenlagt. 
Opptelling av typene AFLI og SVT er uten AV-knuter. Typene med AV-knute for 
forløpene AFLI og SVT vises samlet i egen rad.
 

```{r typeForlopAar, echo = FALSE, results = "asis"}
cap <- paste("Totalt antall forløp fra ", 
             hospitalNameShort, " sammenlignet med nasjonale tall. ", 
             "Tabellen viser forløp fra det siste hele året samt alle ", 
             "fullførte måneder hittil i år for hver av de 4 forløpstypene ",
             " samt AV-knuter: ",
             "Atrieflimmer/atypisk flutter (AFLI uten AV-knuter), Ventrikkeltakykardi (VT), ", 
             "Supraventrikulær takykardi (SVT uten AV-knuter), ", 
             "Elektrofysiologisk undersøkelse (EFU) eller ",
             "AV-knuter for typene AFLI eller SVT.")

tab_forlopstype_AVknute <- data.frame(
  Forlopstype = c("AFLI (uten AV-knute)",
                  "VT",
                  "SVT (uten AV-knute)",
                  "EFU",
                  "AV-knute (AFLI eller SVT)"))


forlopstype_lokalt_fjor <- d_ablanor_nasjonalt %>%
  dplyr::filter(centreid %in% params$reshId,
                aar %in% periode_data$sisteHeleYear) %>% 
  dplyr::count(forlopstype_med_AVknute) %>% 
  janitor::adorn_totals() %>% 
  dplyr::select("forlopstype_med_AVknute", "n") %>% 
  dplyr::rename("Forlopstype" = forlopstype_med_AVknute, 
                "Antall_fjor" = n)

forlopstype_lokalt_aar <- d_ablanor_nasjonalt %>%
  dplyr::filter(centreid %in% params$reshId,
                aar %in% periode_data$nyesteRegYear) %>% 
  dplyr::count(forlopstype_med_AVknute) %>% 
  janitor::adorn_totals() %>% 
  dplyr::select("forlopstype_med_AVknute", "n") %>% 
  dplyr::rename("Forlopstype" = forlopstype_med_AVknute, 
                "Antall_aar" = n)

forlopstype_nasjonalt_fjor <- d_ablanor_nasjonalt %>%
  dplyr::filter(aar %in% periode_data$sisteHeleYear) %>%
  dplyr::count(forlopstype_med_AVknute) %>% 
  janitor::adorn_totals() %>% 
  dplyr::select("forlopstype_med_AVknute", "n") %>% 
  dplyr::rename("Forlopstype" = forlopstype_med_AVknute, 
                "Nasjonalt_fjor" = n)

forlopstype_nasjonalt_aar <- d_ablanor_nasjonalt %>%
  dplyr::filter(aar %in% periode_data$nyesteRegYear) %>%
  dplyr::count(forlopstype_med_AVknute) %>% 
  janitor::adorn_totals() %>% 
  dplyr::select("forlopstype_med_AVknute", "n") %>% 
  dplyr::rename("Forlopstype" = forlopstype_med_AVknute, 
                "Nasjonalt_aar" = n)


tabForlopstype <-  tab_forlopstype_AVknute %>%
  dplyr::left_join(.,
                   forlopstype_lokalt_fjor,
                   by = "Forlopstype") %>% 
  dplyr::left_join(.,
                   forlopstype_nasjonalt_fjor,
                   by = "Forlopstype") %>% 
  dplyr::left_join(.,
                   forlopstype_lokalt_aar,
                   by = "Forlopstype") %>% 
  dplyr::left_join(.,
                   forlopstype_nasjonalt_aar,
                   by = "Forlopstype") %>% 
  janitor::adorn_totals(where = "row", name = "Totalt")

tabForlopstype[tabForlopstype == 0] <- " - "
tabForlopstype[is.na(tabForlopstype)] <- " - "

colnames(tabForlopstype)[2] <- paste0("Totalt i ", periode_data$sisteHeleYear)
colnames(tabForlopstype)[3] <- paste0("Nasjonalt i ", periode_data$sisteHeleYear)
colnames(tabForlopstype)[4] <- paste0("Totalt hittil i ", periode_data$nyesteRegYear)
colnames(tabForlopstype)[5] <- paste0("Nasjonalt hittil i ",
                                      periode_data$nyesteRegYear)

align <- c("l", rep("r", ncol(tabForlopstype)-1))


if(params$tableFormat %in% "html") {
  tabForlopstype %>% rename(" " = "Forlopstype") %>%   
  rapbase::mst(.,
               type = params$tableFormat,
               cap = cap,
               digs = 1,
               align = align,
               fs = 9,
               lsd = FALSE) %>% 
    kableExtra::column_spec(column = 3,
                            background = "#EBEBEB") %>% 
    kableExtra::column_spec(column = ncol(tabForlopstype),
                            background = "#EBEBEB") %>% 
    kableExtra::row_spec(row = nrow(tabForlopstype),
                         background = "#EBEBEB")
  
  
} else if (params$tableFormat %in% "pdf") {
  tabForlopstype %>% rename(" " = "Forlopstype") %>%
  rapbase::mst(.,
               type = params$tableFormat,
               cap = cap,
               digs = 1,
               align = align,
               fs = 9,
               lsd = FALSE) %>%
    kableExtra::kable_styling(latex_options = c("scale_down"),
                              font_size = 8) %>%
    kableExtra::row_spec(row = nrow(tabForlopstype)-1, hline_after = TRUE) %>%
    kableExtra::add_header_above(
      .,
      header = c("",
                 setNames(2,
                          periode_data$sisteHeleYear),
                 setNames((ncol(tabForlopstype)-3),
                          periode_data$nyesteRegYear)),
      bold = TRUE,
      font_size = 10)
}

```



`r if(params$tableFormat !="pdf") {"<!--"}`
\newpage
`r if(params$tableFormat !="pdf") {"-->"}`


# Komplikasjoner
I Ablanor registreres følgende: "Skjedde det komplikasjoner som følge av 
operasjonen?". Dette kan enten være komplikasjoner som oppstod umiddelbart 
etter operasjonen eller som var senkomplikasjoner som (sannsynligvis) skyldtes 
operasjonen (hendelser innen 4 dager).




```{r komplikasjonerTab, echo = FALSE, results = "asis"}
caption <- paste0("Antall komplikasjoner registrert ved ", hospitalNameShort, 
                   " det siste hele året samt hittil i år sammenlignet med nasjonale tall. ")

d_ablanor_hendelse_innen4dager_nasjonalt <- d_ablanor_hendelse_nasjonalt %>% 
  filter(dager_pros_hendelse <= 4)

tab_komp <- data.frame(
  Komplikasjoner = c("AV-fistel",
                 "Pseudoaneurisme",
                 "Blødning",
                 "Infeksjon",
                 "Tamponade",
                 "N. frenicus parese",
                 "Apoplexi/TIA",
                 "AV-blokk/PM",
                 "Pulmonalvenestenose",
                 "Øsofagusfistel",
                 "Hjerteinfarkt eller iskemi",
                 "Perikarditt/perikardvæske",
                 "Død",
                 "Annen komplikasjon",
                 "Totalt"))

# Lokalt i fjor

tab_kompl_pros_lokalt_fjor <- d_ablanor_nasjonalt %>% 
  dplyr::filter(aar %in% periode_data$sisteHeleYear,
                centreid %in% params$reshId,
                komp_janei %in% 1)  %>% 
  mutate(komp_tekst = case_when(
    komp_av_fistel %in% 1 ~ "AV-fistel",
    komp_pseudoan %in% 1 ~ "Pseudoaneurisme",
    komp_blodning %in% 1 ~ "Blødning",
    komp_infek %in% 1 ~ "Infeksjon",
    komp_tamp %in% 1 ~ "Tamponade",
    komp_nfren %in% 1 ~ "N. frenicus parese",
    komp_apoplexi %in% 1 ~ "Apoplexi/TIA",
    komp_avblokk_pm %in% 1 ~ "AV-blokk/PM",
    komp_pulm %in% 1 ~ "Pulmonalvenestenose",
    komp_osofag %in% 1 ~ "Øsofagusfistel",
    komp_koronar %in% 1 ~ "Hjerteinfarkt eller iskemi",
    komp_perikard %in% 1 ~ "Perikarditt/perikardvæske",
    komp_dod %in% 1 ~ "Død",
    komp_annen %in% 1 ~ "Annen komplikasjon",
    .default = NA_character_
  )) %>% 
  count(komp_tekst) %>% 
  janitor::adorn_totals(name = "Totalt") %>%
  dplyr::rename("Komplikasjoner" = komp_tekst,
                "Antall fra pros" = n)


tab_kompl_hendelse_lokalt_fjor <- d_ablanor_hendelse_innen4dager_nasjonalt %>% 
  dplyr::filter(aar %in% periode_data$sisteHeleYear,
                centreid %in% params$reshId,
                adhoc_komp_janei %in% 1)  %>% 
  mutate(komp_tekst = case_when(
    adhoc_komp_av_fistel %in% 1 ~ "AV-fistel",
    adhoc_komp_pseudoan %in% 1 ~ "Pseudoaneurisme",
    adhoc_komp_blodning %in% 1 ~ "Blødning",
    adhoc_komp_infek %in% 1 ~ "Infeksjon",
    adhoc_komp_tamp %in% 1 ~ "Tamponade",
    adhoc_komp_nfren %in% 1 ~ "N. frenicus parese",
    adhoc_komp_apoplexi %in% 1 ~ "Apoplexi/TIA",
    adhoc_komp_avblokk_pm %in% 1 ~ "AV-blokk/PM",
    adhoc_komp_pulm %in% 1 ~ "Pulmonalvenestenose",
    adhoc_komp_osofag %in% 1 ~ "Øsofagusfistel",
    adhoc_komp_koronar %in% 1 ~ "Hjerteinfarkt eller iskemi",
    adhoc_komp_perikard %in% 1 ~ "Perikarditt/perikardvæske",
    adhoc_komp_dod %in% 1 ~ "Død",
    adhoc_komp_annen %in% 1 ~ "Annen komplikasjon",
    .default = NA_character_
  )) %>% 
  count(komp_tekst) %>% 
  janitor::adorn_totals(name = "Totalt") %>%
  dplyr::rename("Komplikasjoner" = komp_tekst,
                "Antall fra hendelse" = n)


tab_komp_lokalt_fjor <- tab_komp %>% 
  dplyr::left_join(., tab_kompl_pros_lokalt_fjor, by = "Komplikasjoner") %>% 
  dplyr::left_join(., tab_kompl_hendelse_lokalt_fjor, by = "Komplikasjoner") %>% 
  janitor::adorn_totals("col", name = "Antall_fjor") %>% 
  select(Komplikasjoner, Antall_fjor)

# Lokalt i år

tab_kompl_pros_lokalt_aar <- d_ablanor_nasjonalt %>% 
  dplyr::filter(aar %in% periode_data$nyesteRegYear,
                centreid %in% params$reshId,
                komp_janei %in% 1)  %>% 
  mutate(komp_tekst = case_when(
    komp_av_fistel %in% 1 ~ "AV-fistel",
    komp_pseudoan %in% 1 ~ "Pseudoaneurisme",
    komp_blodning %in% 1 ~ "Blødning",
    komp_infek %in% 1 ~ "Infeksjon",
    komp_tamp %in% 1 ~ "Tamponade",
    komp_nfren %in% 1 ~ "N. frenicus parese",
    komp_apoplexi %in% 1 ~ "Apoplexi/TIA",
    komp_avblokk_pm %in% 1 ~ "AV-blokk/PM",
    komp_pulm %in% 1 ~ "Pulmonalvenestenose",
    komp_osofag %in% 1 ~ "Øsofagusfistel",
    komp_koronar %in% 1 ~ "Hjerteinfarkt eller iskemi",
    komp_perikard %in% 1 ~ "Perikarditt/perikardvæske",
    komp_dod %in% 1 ~ "Død",
    komp_annen %in% 1 ~ "Annen komplikasjon",
    .default = NA_character_
  )) %>% 
  count(komp_tekst) %>% 
  janitor::adorn_totals(name = "Totalt") %>%
  dplyr::rename("Komplikasjoner" = komp_tekst,
                "Antall fra pros" = n)


tab_kompl_hendelse_lokalt_aar <- d_ablanor_hendelse_innen4dager_nasjonalt %>% 
  dplyr::filter(aar %in% periode_data$nyesteRegYear,
                centreid %in% params$reshId,
                adhoc_komp_janei %in% 1)  %>% 
  mutate(komp_tekst = case_when(
    adhoc_komp_av_fistel %in% 1 ~ "AV-fistel",
    adhoc_komp_pseudoan %in% 1 ~ "Pseudoaneurisme",
    adhoc_komp_blodning %in% 1 ~ "Blødning",
    adhoc_komp_infek %in% 1 ~ "Infeksjon",
    adhoc_komp_tamp %in% 1 ~ "Tamponade",
    adhoc_komp_nfren %in% 1 ~ "N. frenicus parese",
    adhoc_komp_apoplexi %in% 1 ~ "Apoplexi/TIA",
    adhoc_komp_avblokk_pm %in% 1 ~ "AV-blokk/PM",
    adhoc_komp_pulm %in% 1 ~ "Pulmonalvenestenose",
    adhoc_komp_osofag %in% 1 ~ "Øsofagusfistel",
    adhoc_komp_koronar %in% 1 ~ "Hjerteinfarkt eller iskemi",
    adhoc_komp_perikard %in% 1 ~ "Perikarditt/perikardvæske",
    adhoc_komp_dod %in% 1 ~ "Død",
    adhoc_komp_annen %in% 1 ~ "Annen komplikasjon",
    .default = NA_character_
  )) %>% 
  count(komp_tekst) %>% 
  janitor::adorn_totals(name = "Totalt") %>%
  dplyr::rename("Komplikasjoner" = komp_tekst,
                "Antall fra hendelse" = n)


tab_komp_lokalt_aar <- tab_komp %>% 
  dplyr::left_join(., tab_kompl_pros_lokalt_aar, by = "Komplikasjoner") %>% 
  dplyr::left_join(., tab_kompl_hendelse_lokalt_aar, by = "Komplikasjoner") %>% 
  janitor::adorn_totals("col", name = "Antall_aar") %>% 
  select(Komplikasjoner, Antall_aar)


# Nasjonalt i fjor

tab_kompl_pros_nasjonalt_fjor <- d_ablanor_nasjonalt %>% 
  dplyr::filter(aar %in% periode_data$sisteHeleYear,
                komp_janei %in% 1)  %>% 
  mutate(komp_tekst = case_when(
    komp_av_fistel %in% 1 ~ "AV-fistel",
    komp_pseudoan %in% 1 ~ "Pseudoaneurisme",
    komp_blodning %in% 1 ~ "Blødning",
    komp_infek %in% 1 ~ "Infeksjon",
    komp_tamp %in% 1 ~ "Tamponade",
    komp_nfren %in% 1 ~ "N. frenicus parese",
    komp_apoplexi %in% 1 ~ "Apoplexi/TIA",
    komp_avblokk_pm %in% 1 ~ "AV-blokk/PM",
    komp_pulm %in% 1 ~ "Pulmonalvenestenose",
    komp_osofag %in% 1 ~ "Øsofagusfistel",
    komp_koronar %in% 1 ~ "Hjerteinfarkt eller iskemi",
    komp_perikard %in% 1 ~ "Perikarditt/perikardvæske",
    komp_dod %in% 1 ~ "Død",
    komp_annen %in% 1 ~ "Annen komplikasjon",
    .default = NA_character_
  )) %>% 
  count(komp_tekst) %>% 
  janitor::adorn_totals(name = "Totalt") %>%
  dplyr::rename("Komplikasjoner" = komp_tekst,
                "Antall fra pros" = n)


tab_kompl_hendelse_nasjonalt_fjor <- d_ablanor_hendelse_innen4dager_nasjonalt %>% 
  dplyr::filter(aar %in% periode_data$sisteHeleYear,
                adhoc_komp_janei %in% 1)  %>% 
  mutate(komp_tekst = case_when(
    adhoc_komp_av_fistel %in% 1 ~ "AV-fistel",
    adhoc_komp_pseudoan %in% 1 ~ "Pseudoaneurisme",
    adhoc_komp_blodning %in% 1 ~ "Blødning",
    adhoc_komp_infek %in% 1 ~ "Infeksjon",
    adhoc_komp_tamp %in% 1 ~ "Tamponade",
    adhoc_komp_nfren %in% 1 ~ "N. frenicus parese",
    adhoc_komp_apoplexi %in% 1 ~ "Apoplexi/TIA",
    adhoc_komp_avblokk_pm %in% 1 ~ "AV-blokk/PM",
    adhoc_komp_pulm %in% 1 ~ "Pulmonalvenestenose",
    adhoc_komp_osofag %in% 1 ~ "Øsofagusfistel",
    adhoc_komp_koronar %in% 1 ~ "Hjerteinfarkt eller iskemi",
    adhoc_komp_perikard %in% 1 ~ "Perikarditt/perikardvæske",
    adhoc_komp_dod %in% 1 ~ "Død",
    adhoc_komp_annen %in% 1 ~ "Annen komplikasjon",
    .default = NA_character_
  )) %>% 
  count(komp_tekst) %>% 
  janitor::adorn_totals(name = "Totalt") %>%
  dplyr::rename("Komplikasjoner" = komp_tekst,
                "Antall fra hendelse" = n)


tab_komp_nasjonalt_fjor <- tab_komp %>% 
  dplyr::left_join(., tab_kompl_pros_nasjonalt_fjor, by = "Komplikasjoner") %>% 
  dplyr::left_join(., tab_kompl_hendelse_nasjonalt_fjor, by = "Komplikasjoner") %>% 
  janitor::adorn_totals("col", name = "Nasjonalt_fjor") %>% 
  select(Komplikasjoner, Nasjonalt_fjor)


# Nasjonalt i aar

tab_kompl_pros_nasjonalt_aar <- d_ablanor_nasjonalt %>% 
  dplyr::filter(aar %in% periode_data$nyesteRegYear,
                komp_janei %in% 1)  %>% 
  mutate(komp_tekst = case_when(
    komp_av_fistel %in% 1 ~ "AV-fistel",
    komp_pseudoan %in% 1 ~ "Pseudoaneurisme",
    komp_blodning %in% 1 ~ "Blødning",
    komp_infek %in% 1 ~ "Infeksjon",
    komp_tamp %in% 1 ~ "Tamponade",
    komp_nfren %in% 1 ~ "N. frenicus parese",
    komp_apoplexi %in% 1 ~ "Apoplexi/TIA",
    komp_avblokk_pm %in% 1 ~ "AV-blokk/PM",
    komp_pulm %in% 1 ~ "Pulmonalvenestenose",
    komp_osofag %in% 1 ~ "Øsofagusfistel",
    komp_koronar %in% 1 ~ "Hjerteinfarkt eller iskemi",
    komp_perikard %in% 1 ~ "Perikarditt/perikardvæske",
    komp_dod %in% 1 ~ "Død",
    komp_annen %in% 1 ~ "Annen komplikasjon",
    .default = NA_character_
  )) %>% 
  count(komp_tekst) %>% 
  janitor::adorn_totals(name = "Totalt") %>%
  dplyr::rename("Komplikasjoner" = komp_tekst,
                "Antall fra pros" = n)


tab_kompl_hendelse_nasjonalt_aar <- d_ablanor_hendelse_innen4dager_nasjonalt %>% 
  dplyr::filter(aar %in% periode_data$nyesteRegYear,
                adhoc_komp_janei %in% 1)  %>% 
  mutate(komp_tekst = case_when(
    adhoc_komp_av_fistel %in% 1 ~ "AV-fistel",
    adhoc_komp_pseudoan %in% 1 ~ "Pseudoaneurisme",
    adhoc_komp_blodning %in% 1 ~ "Blødning",
    adhoc_komp_infek %in% 1 ~ "Infeksjon",
    adhoc_komp_tamp %in% 1 ~ "Tamponade",
    adhoc_komp_nfren %in% 1 ~ "N. frenicus parese",
    adhoc_komp_apoplexi %in% 1 ~ "Apoplexi/TIA",
    adhoc_komp_avblokk_pm %in% 1 ~ "AV-blokk/PM",
    adhoc_komp_pulm %in% 1 ~ "Pulmonalvenestenose",
    adhoc_komp_osofag %in% 1 ~ "Øsofagusfistel",
    adhoc_komp_koronar %in% 1 ~ "Hjerteinfarkt eller iskemi",
    adhoc_komp_perikard %in% 1 ~ "Perikarditt/perikardvæske",
    adhoc_komp_dod %in% 1 ~ "Død",
    adhoc_komp_annen %in% 1 ~ "Annen komplikasjon",
    .default = NA_character_
  )) %>% 
  count(komp_tekst) %>% 
  janitor::adorn_totals(name = "Totalt") %>%
  dplyr::rename("Komplikasjoner" = komp_tekst,
                "Antall fra hendelse" = n)


tab_komp_nasjonalt_aar <- tab_komp %>% 
  dplyr::left_join(., tab_kompl_pros_nasjonalt_aar, by = "Komplikasjoner") %>% 
  dplyr::left_join(., tab_kompl_hendelse_nasjonalt_aar, by = "Komplikasjoner") %>% 
  janitor::adorn_totals("col", name = "Nasjonalt_aar") %>% 
  select(Komplikasjoner, Nasjonalt_aar)


tab_komp_samlet <- tab_komp %>% 
  dplyr::left_join(., tab_komp_lokalt_fjor, by = "Komplikasjoner") %>% 
  dplyr::left_join(., tab_komp_nasjonalt_fjor, by = "Komplikasjoner") %>% 
  dplyr::left_join(., tab_komp_lokalt_aar, by = "Komplikasjoner") %>% 
  dplyr::left_join(., tab_komp_nasjonalt_aar, by = "Komplikasjoner")

colnames(tab_komp_samlet)[2] <- paste0("Totalt i ", periode_data$sisteHeleYear)
colnames(tab_komp_samlet)[3] <- paste0("Nasjonalt i ", periode_data$sisteHeleYear)
colnames(tab_komp_samlet)[4] <- paste0("Totalt hittil i ", periode_data$nyesteRegYear)
colnames(tab_komp_samlet)[5] <- paste0("Nasjonalt hittil i ",
                                      periode_data$nyesteRegYear)

align <- c("l", rep("r", ncol(tab_komp_samlet)-1))

if(params$tableFormat %in% "html") {
  tab_komp_samlet %>%   
  rapbase::mst(.,
               type = params$tableFormat,
               cap = cap,
               digs = 1,
               align = align,
               fs = 9,
               lsd = FALSE) %>% 
    kableExtra::column_spec(column = 3,
                            background = "#EBEBEB") %>% 
    kableExtra::column_spec(column = ncol(tab_komp_samlet),
                            background = "#EBEBEB") %>% 
    kableExtra::row_spec(row = nrow(tab_komp_samlet),
                         background = "#EBEBEB")
  
  } else if (params$tableFormat %in% "pdf") {
  tab_komp_samlet %>%
  rapbase::mst(.,
               type = params$tableFormat,
               cap = cap,
               digs = 1,
               align = align,
               fs = 9,
               lsd = FALSE) %>%
    kableExtra::kable_styling(latex_options = c("scale_down"),
                              font_size = 8) %>%
    kableExtra::row_spec(row = nrow(tab_komp_samlet)-1, hline_after = TRUE) %>%
    kableExtra::add_header_above(
      .,
      header = c("",
                 setNames(2,
                          periode_data$sisteHeleYear),
                 setNames((ncol(tab_komp_samlet)-3),
                          periode_data$nyesteRegYear)),
      bold = TRUE,
      font_size = 10)
  }

```


<br>


```{r pagebreak3, results = "asis", eval = (params$tableFormat == "pdf")}
cat("\n\n\\pagebreak\n")
```



# Prosedyrevarighet
Forløp med manglende prosedyrevarighet (n = 
`r d_ablanor %>%  dplyr::filter(is.na(pros_varighet)) %>%  nrow()`) er fjernet
fra datagrunnlaget. 

Figur \@ref(fig:figProsedyreVarighetMin) viser et boxplot med fordeling av 
prosedyrevarighet per måned. Den blå boksen markerer nedre og øvre
kvartil, medianen er markert av den tykke linjen.
Punktene utenfor greinene viser uteliggere, det vil si 
forløp med usedvanlig kort eller lang prosedyrevarighet 
(prosedyrevarighet lengre enn 1,5 ganger interkvartil bredde over øvre kvartil/
under nedre kvartil).



```{r figProsedyreVarighetMin, fig.cap = fig.cap, fig.pos = "H", fig.align = 'center',  out.width = "80%", fig.asp = 0.8}

fig.cap <-  "Prosedyrevarighet i minutter per måned."

d_ablanor %>% 
  dplyr::filter(!is.na(.data$pros_varighet)) %>% 
  ggplot2::ggplot(ggplot2::aes(y = maaned, x = pros_varighet)) +
  ggplot2::geom_boxplot(fill = colPrimary[4]) +
  ablanor::ablanor_plot_theme() +
  ggplot2::scale_y_discrete(drop = FALSE) + 
  ggplot2::labs(title = paste0("Prosedyrevarighet (minutter) de ",
                               showN, " siste månedene"), 
                subtitle = hospitalNameShort) 

```





```{r pagebreak9, results = "asis", eval = (params$tableFormat == "pdf")}
cat("\n\n\\pagebreak\n")
```

# Røntgentid

Forløp med manglende røntgenvarighet (n = 
`r d_ablanor %>%  dplyr::filter(is.na(rtg_tid)) %>%  nrow()`) er fjernet
fra datagrunnlaget. 


Figur \@ref(fig:figRontgenVarighetMin) viser et boxplot med fordeling av 
røntgenvarighet per måned. Den blå boksen markerer nedre og øvre
kvartil, medianen er markert av den tykke linjen.
Punktene utenfor greinene viser uteliggere, det vil si 
forløp med usedvanlig kort eller lang prosedyrevarighet 
(prosedyrevarighet lengre enn 1,5 ganger interkvartil bredde over øvre kvartil/
under nedre kvartil).


Tabell \@ref(tab:tabellRontgenvarighet1) viser gjennomsnittlig røntgenvarighet
per måned, totalt og for hver av de fire forløpstypene.



```{r figRontgenVarighetMin, fig.cap = cap, fig.pos = "H", fig.align = 'center',  out.width = "100%", fig.asp = 0.8}
cap <- "Røntgentid i minutter per måned."

d_varighet_tot_maaned <- d_ablanor %>%
  dplyr::filter(!is.na(.data$rtg_tid)) %>% 
  dplyr::select("maaned", "rtg_tid") %>%
  dplyr::mutate(rtg_tid = as.numeric(.data$rtg_tid)) %>%
  dplyr::mutate(rtg_tid_min = .data$rtg_tid / 60)

d_varighet_tot_maaned %>% 
  ggplot2::ggplot(ggplot2::aes(y = maaned, x = rtg_tid_min)) +
  ggplot2::geom_boxplot(fill = colPrimary[4]) +
  ablanor::ablanor_plot_theme() +
  ggplot2::scale_y_discrete(drop = FALSE) + 
  ggplot2::labs(title = paste0("Røntgenvarighet (minutter) de ",
                               showN, " siste månedene"), 
                subtitle = hospitalNameShort) 

```


```{r tabellRontgenvarighetForberede}
# VARIGHET røntgen per måned TOTALT:
d_varighetRtg_mnd <- d_ablanor %>%
  dplyr::filter(!is.na(.data$rtg_tid)) %>% 
  dplyr::select("rtg_tid", "maaned") %>%
  dplyr::mutate(rtg_tid = as.numeric(.data$rtg_tid)) %>%
  dplyr::mutate(rtg_tid_min = .data$rtg_tid / 60) %>%
  dplyr::group_by(.data$maaned, .drop = FALSE) %>%
  dplyr::summarise(rtg_meanN = paste0(sprintf("%0.0f",
                                              mean(.data$rtg_tid_min)), 
                                      " [", sprintf("%0.0f", dplyr::n()), "]"),
                   .groups = 'drop') %>%
  dplyr::transmute(maaned = .data$maaned, Totalt = .data$rtg_meanN) 


# FORLØPSTYPE
d_varighetRtg_forlop <- d_ablanor %>%
  dplyr::filter(!is.na(.data$rtg_tid)) %>%
  dplyr::select("forlopstype", "rtg_tid", "maaned") %>%
  dplyr::group_by(.data$forlopstype, .data$maaned, .drop = FALSE) %>%
  dplyr::mutate(rtg_tid = as.numeric(.data$rtg_tid)) %>%
  dplyr::mutate(rtg_tid_min = .data$rtg_tid / 60) %>%
  dplyr::summarise(rtg_meanN = paste0(sprintf("%0.0f",
                                              mean(.data$rtg_tid_min)),
                                      " [",
                                      sprintf("%0.0f", dplyr::n()), "]"),
                   .groups = 'drop') %>%
  dplyr::mutate(rtg_meanN = dplyr::recode(.data$rtg_meanN, 
                                          "NaN [0]" = " -- ")) %>% 
  dplyr::ungroup() %>% 
  dplyr::rename(legend = .data$forlopstype, value = .data$rtg_meanN) %>%
  ablanor::leggTilTomme_PivotWide(., remove_NAcols = TRUE) %>% 
  dplyr::rename("AFLI"="1",
                "VT"="2", 
                "SVT"="3", 
                "EFU"="4")


d_varighetRtg_TOTAL<- dplyr::full_join(d_varighetRtg_mnd,
                                       d_varighetRtg_forlop,
                                       by = "maaned") %>% 
  dplyr::arrange(desc(.data$maaned))
```


```{r tabellRontgenvarighet1}
cap <- paste0("Gjennomsnittlig røntgenvarighet i minutter de ", 
              showN, " siste månedene. ",
              "Totalt og for hver forløpstype. ", 
              "Gjennomsnitt [antall].")

knitr::kable(
  x = d_varighetRtg_TOTAL,
  format = switch(params$tableFormat,
                  pdf = "latex",
                  html = "html"),
  align = c("l", rep("c", 5)),
  caption = cap,
  booktabs = TRUE) %>%
  kableExtra::add_header_above(c(" " = 1,
                                 " " = 1,
                                 "Forløpstype" = 4)) %>%
  gsub("maaned", "Måned", .) %>%
  ablanor::mst_short(., type = params$tableFormat,
                     lsd = FALSE, 
                     fs = 8, 
                     full_width = FALSE)
```


