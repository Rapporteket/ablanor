---
params:
  title: tom tittel
  author: ukjent forfatter
  hospitalName: ukjent sykehus
  tableFormat: html
  reshId: 999999
  registryName: rapbase
  userFullName: Tore Tester
  userRole: ukjent rolle
  userOperator: ukjent operatør
title: |  
  | Nasjonalt register for ablasjonsbehandling og elektrofysiologi i Norge (AblaNor)
  |
  | __`r paste0("Månedsrapport for ", params$hospitalName)`__
  |
  |
abstract: '`r paste0("Denne rapporten oppsummerer nøkkeltall for registreringer i AblaNor utført av ",  params$hospitalName, " de siste 12 månedene.  Bare forløp som har resultert i en prosedyre, eventuelt en avbrutt en, teller med i datagrunnlaget. Opptellingene er gjort per forløp i perioden, det vil si at en pasient som har hatt mer enn et forløp vil telle flere ganger.") `'
date: '`r format(Sys.time(), "%d. %B, %Y")`'
registryName: '`r params$registryName`'
reglogo: '`r system.file("logoAblanor.png", package = "ablanor")`'
regtext: '`r readLines(system.file("registryShortDescription.txt", package = "ablanor"))`'
userFullName: '`r params$userFullName`'
output:
  fig_caption: yes
---


```{r knitrOptions, include=FALSE}
library(ablanor)
library(magrittr)
library(knitr)
library(kableExtra)
library(dplyr)
library(tidyr)
library(ggplot2)

# make sure to use a temporary directory AND absolute paths, e.g. that figs
# can be found also when deployed at a server. See below link for explanation
# https://rgriff23.github.io/2017/04/25/how-to-knit-for-mysite.html
# Also make sure we use tempdir() as working directory so we do not clutter
# the package of the hosting shiny app
# workDir <- tempdir()
# knitr::opts_knit$set(base.dir=workDir, base.url=file.path(paste0(tempdir(), "/")), root.dir = workDir)

# Handle both html and latex (pdf) output. Actually to avoid setting 'format'
# for each kable call
# inspired by https://stackoverflow.com/questions/46080853/why-does-rendering-a-pdf-from-rmarkdown-require-closing-rstudio-between-renders
options(knitr.table.format = params$tableFormat)
knitr::opts_chunk$set(warnings = FALSE, echo = FALSE)
options(stringsAsFactors = FALSE)

# For some reason Shiny Server does not get the server locale settings right.
# To display dates correct, enforce locale here:
Sys.setlocale("LC_TIME", "nb_NO.UTF-8")
``` 




```{r SKDEcol, include=FALSE}
colPrimary <- c("#000059", "#084594", "#2171b5", "#4292c6", "#6baed6", "#c6dbef")
colNeutral <- c("#4D4D4D", "#737373", "#A6A6A6", "#DADADA")
colKontrast <- "#FF7260"
```

```{r parametre}
showN <- 12

#Egendefinerte kortnavn:
hospitalNameShort <- ablanor::getHospitalName(reshId = params$reshId, 
                                              shortName = TRUE,
                                              newNames = TRUE)
```


```{r latest_entry, include=FALSE, eval=TRUE}

# DATAGRUNNLAG: PERIODE
# NYESTE DATO: 
# Finne nyeste prosedyredato i prosedyre-tabellen. Vi ønsker ikke at 
# forhåndsregisrerte planlagte forløp kommer med i rapporten. Derfor brukes
# gårsdagens dato som referanse, ingen forløp etter denne kommer med .  
# Vi vil dermed også kunne se dersom ingen nye registreringer gjøres eller om
# overføringer har stoppet opp

# ELDSTE DATO: 
# 12 komplette måneder før siste dato

nyeste_reg <- ablanor::getLatestEntry()

periode_data <- data.frame(
  siste_dato = min((as.Date(Sys.time()) - 1), 
                   nyeste_reg)) %>% 
  dplyr::mutate(forste_dato  = lubridate::floor_date(.data$siste_dato, 
                                                     "month") - months(showN))


```


```{r GetData}
d_ablanor <- ablanor::getBaseregProsData(singleRow = FALSE, 
                                         reshId = params$reshId,
                                         userRole = params$userRole, 
                                         fromDate = periode_data$forste_dato, 
                                         toDate = periode_data$siste_dato)

d_ablanor_nasjonalt <- ablanor::getBaseregProsData(singleRow = FALSE, 
                                                   reshId = params$reshId,
                                                   userRole = "SC", 
                                                   fromDate = periode_data$forste_dato, 
                                                   toDate = periode_data$siste_dato)

tab_list_hendelse_nasjonalt <- ablanor::getHendelse(singleRow = FALSE, 
                                                     reshId = params$reshId,
                                                     userRole = "SC", 
                                                     fromDate = NULL, 
                                                     toDate = NULL)


d_hendelse_nasjonalt <- tab_list_hendelse_nasjonalt$d_hendelse %>% 
      dplyr::rename_at(dplyr::vars(KOMP_JANEI:STATUS),
                       function(x) {
                         paste0("adhoc_", x)
                       }) %>%
      dplyr::rename("MCEID_adhoc" = "MCEID") %>%
      dplyr::select(MCEID_adhoc,
                    CENTREID,
                    DATO_ADHOC,
                    adhoc_KOMP_JANEI:adhoc_STATUS)


tab_list_basereg_nasjonalt <- ablanor::getBasereg(singleRow = FALSE, 
                                           reshId = params$reshId,
                                           userRole = "SC", 
                                           fromDate = periode_data$forste_dato, 
                                           toDate = periode_data$siste_dato)

d_basereg_nasjonalt <- tab_list_basereg_nasjonalt$d_basereg %>% 
  dplyr::select(MCEID, CENTREID, HOYDE, VEKT)

tab_list_pros_nasjonalt <- ablanor::getPros(singleRow = FALSE, 
                                            reshId = params$reshId,
                                            userRole = "SC", 
                                            fromDate = periode_data$forste_dato, 
                                            toDate = periode_data$siste_dato)

d_pros_nasjonalt <- tab_list_pros_nasjonalt$d_pros %>% 
  dplyr::select(MCEID, CENTREID, FORLOPSTYPE, DATO_PROS)


tab_list_mce_nasjonalt <- ablanor::getMce(singleRow = FALSE, 
                                          reshId = params$reshId,
                                          userRole = "SC", 
                                          fromDate = periode_data$forste_dato, 
                                          toDate = periode_data$siste_dato)

d_mce_nasjonalt <- tab_list_mce_nasjonalt$d_mce %>% 
  dplyr::select(MCEID, CENTREID, MCETYPE, PARENTMCEID)


names(d_hendelse_nasjonalt) <- tolower(names(d_hendelse_nasjonalt))
names(d_basereg_nasjonalt) <- tolower(names(d_basereg_nasjonalt))
names(d_pros_nasjonalt) <- tolower(names(d_pros_nasjonalt))
names(d_mce_nasjonalt) <- tolower(names(d_mce_nasjonalt))

d_hendelse_nasjonalt %<>% dplyr::left_join(.,
                                     d_mce_nasjonalt %>% 
                                       dplyr::filter(mcetype == 8) %>%
                                       dplyr::select(mceid, parentmceid) %>%
                                       dplyr::rename(mceid_adhoc = mceid,
                                                     mceid = parentmceid),
                                     by = "mceid_adhoc")

# Legg til hendelse i pasient - prosedyre - data
d_ablanor_hendelse_nasjonalt <-  dplyr::right_join(
  x = dplyr::left_join(d_basereg_nasjonalt, d_pros_nasjonalt, by = c("mceid", "centreid")),
  y = d_hendelse_nasjonalt,
  by = c("mceid", "centreid")) %>%
  
  # Antall dager fra prosedyre til hendelse
  dplyr::mutate(dager_pros_hendelse = as.numeric(difftime(
    dato_adhoc,
    dato_pros,
    units = "days"
  )))


d_ablanor_hendelse_nasjonalt %<>% filter(
  dato_pros >= periode_data$forste_dato,
  dato_pros <= periode_data$siste_dato)


```

```{r forste_siste_registrering_SHUS}

periode_data$forste_dato_shus <- d_ablanor %>% 
  dplyr::summarise(min(.data$dato_pros)) %>% 
  dplyr::pull()

periode_data$nyeste_dato_shus <- d_ablanor %>% 
  dplyr::summarise(max(.data$dato_pros)) %>% 
  dplyr::pull()


periode_data$forste_dato_shus <- d_ablanor_nasjonalt %>% 
  dplyr::summarise(min(.data$dato_pros)) %>% 
  dplyr::pull()

periode_data$nyeste_dato_shus <- d_ablanor_nasjonalt %>% 
  dplyr::summarise(max(.data$dato_pros)) %>% 
  dplyr::pull()

```


```{r Oppdatere_levels}

# OPPDATERE : UKE, MÅNED, ÅR for å få riktig levels i faktorer, også dersom 
# ingen registreringer i løpet av en måned
d_ablanor %<>%
  dplyr::mutate(
    aar = as.ordered(lubridate::year(.data$dato_pros)),
    maaned = as.ordered(format(.data$dato_pros, "%Y-%m"))
  )

d_ablanor_nasjonalt %<>%
  dplyr::mutate(
    aar = as.ordered(lubridate::year(.data$dato_pros)),
    maaned = as.ordered(format(.data$dato_pros, "%Y-%m"))
  )

# OPPDATERE ALLE ANDRE FAKTOR variabler, for å få med alle mulige nivåer
d_ablanor %<>%
  dplyr::mutate(forlopstype = factor(x = forlopstype,
                                     levels = 1:4))

d_ablanor_nasjonalt %<>%
  dplyr::mutate(forlopstype = factor(x = forlopstype,
                                     levels = 1:4))

```


# Datagrunnlag 
Datagrunnlaget for denne rapporten er alle forløp registrert i AblaNor de 
siste `r showN`  månedene: det vil si i intervallet fra  `r format(periode_data$forste_dato , "%d/%m-%Y")` til
`r format(periode_data$siste_dato, "%d/%m-%Y")`. 


Første og siste registrering fra `r hospitalNameShort` i tidsperioden er
henholdsvis `r format(periode_data$forste_dato_shus, "%d/%m-%Y") ` og
`r format(periode_data$nyeste_dato_shus, "%d/%m-%Y") `. 



```{r pagebreak1, results = "asis", eval = (params$tableFormat == "pdf")}
cat("\n\n\\pagebreak\n")
```

# Forløpstype
Forløpene i registrert i AblaNor er en av typene : Atrieflimmer/atypisk flutter
(AFLI), Ventrikkeltakykardi (VT), Supraventrikulær takykardi (SVT) eller 
Elektrofysiologisk undersøkelse (EFU). Dersom forløpstype ikke er registrert
blir verdien NA (not available), dette gjelder forløp der prosedyreskjema ikke
er ferdigstilte. 
Tabellen under (Tabell \@ref(tab:typeForlopAar)) viser antall forløp
registrert i AblaNor fra `r hospitalNameShort` de `r showN` siste månedene, 
for hver forløpstype og sammenlagt. 
Figur \@ref(fig:typeForlopFig) viser antall forløp per
måned, samt fordeling etter forløpstype. 

```{r typeForlopAar}
cap <- paste("Totalt antall forløp fra ", 
             hospitalNameShort, " de ", showN, " siste månedene sammenlignet ",
             "med nasjonale tall. For hver av de 4 forløpstypene: ",
             "Atrieflimmer/atypisk flutter (AFLI), Ventrikkeltakykardi (VT), ", 
             "Supraventrikulær takykardi (SVT) eller ", 
             "Elektrofysiologisk undersøkelse (EFU).")

forlopstype_lokalt <- d_ablanor_nasjonalt %>%
  dplyr::filter(.data$centreid %in% params$reshId) %>% 
  dplyr::count(forlopstype) %>% 
  janitor::adorn_totals() %>% 
  ablanor::legg_til_forlopstype_kortnavn(., total = TRUE, langtnavn = TRUE) %>%
  dplyr::select("forlopstype_tekst", "n") %>% 
  dplyr::rename("Forløpstype" = forlopstype_tekst, 
                "Antall" = n)

forlopstype_nasjonalt <- d_ablanor_nasjonalt %>%
  dplyr::count(forlopstype) %>% 
  janitor::adorn_totals() %>% 
  ablanor::legg_til_forlopstype_kortnavn(., total = TRUE, langtnavn = TRUE) %>%
  dplyr::select("forlopstype_tekst", "n") %>% 
  dplyr::rename("Forløpstype" = forlopstype_tekst, 
                "Nasjonalt" = n)

tabForlopstype <- forlopstype_lokalt %>% 
  left_join(.,
            forlopstype_nasjonalt,
            by = "Forløpstype")

tabForlopstype %>%   
  rapbase::mst(.,
               type = params$tableFormat,
               cap = cap,
               digs = 1,
               align = "lrr",
               fs = 9,
               lsd = FALSE)

```

```{r typeForlopFig, fig.cap = figtekst, fig.pos = "H", fig.align = "center", out.width = "80%", fig.asp = 0.8 }

figtekst <- paste0("Antall registreringer i AblaNor fra ", 
                   hospitalNameShort, " hver måned det siste året. ", 
                   "Tallene i søylene viser antall registrerte forløp per ", 
                   "forløpstype. ", 
                   "Atrieflimmer/atypisk flutter (AFLI), ", 
                   "Ventrikkeltakykardi (VT), ", 
                   "Supraventrikulær takykardi (SVT) eller ", 
                   "Elektrofysiologisk undersøkelse (EFU).")

d_forlop_mnd <- d_ablanor %>%
  dplyr::count(.data$maaned, .data$forlopstype, .drop = FALSE) %>%
  ablanor::legg_til_forlopstype_kortnavn() %>% 
  dplyr::mutate(
    n_uten0 = dplyr::case_when(
      .data$n == 0 ~ "", .data$n != 0 ~ as.character(.data$n)
    )
  ) %>% 
  dplyr::mutate(forlopstype_tekst = factor(
    x = .data$forlopstype_tekst, 
    levels = c("AFLI", "VT", "SVT", "EFU")))


ggplot2::ggplot(
  data = d_forlop_mnd,  
  ggplot2::aes(
    x = .data$n,
    y = .data$maaned,
    fill = .data$forlopstype_tekst
  )
) +
  ggplot2::geom_bar(stat = "identity", 
                    position = ggplot2::position_stack(reverse = TRUE)) +
  ggplot2::scale_fill_manual(values = colPrimary[3:6]) +
  ablanor::ablanor_plot_theme() + 
  ggplot2::labs(title = paste0("Antall registreringer i AblaNor de ",
                               showN, " siste månedene" ),
                subtitle = hospitalNameShort) +
  ggplot2::geom_vline(xintercept = 0, size = 1, colour = "gray45") +
  ggplot2::geom_text(
    ggplot2::aes(label = .data$n_uten0),
    family = "sans",
    position = ggplot2::position_stack(vjust = 0.5, reverse = TRUE)
  ) 

```





```{r pagebreak2, results = "asis", eval = (params$tableFormat == "pdf")}
cat("\n\n\\pagebreak\n")
```


# Komplikasjoner
I Ablanor registreres følgende: "Skjedde det komplikasjoner som følge av 
operasjonen?". Dette kan enten være komplikasjoner som oppstod umiddelbart 
etter operasjonen eller som var senkomplikasjoner som (sannsynligvis) skyldtes 
operasjonen (hendelser innen 4 dager).




```{r komplikasjonerTab}
caption <- paste0("Antall komplikasjoner registrert ved ", hospitalNameShort, 
                   "det siste året sammenlignet med nasjonale tall. ")

d_ablanor_hendelse_innen4dager_nasjonalt <- d_ablanor_hendelse_nasjonalt %>% 
  filter(dager_pros_hendelse <= 4)

tab_komp <- data.frame(
  Komplikasjoner = c("AV-fistel",
                 "Pseudoaneurisme",
                 "Blødning",
                 "Infeksjon",
                 "Tamponade",
                 "N. frenicus parese",
                 "Apoplexi/TIA",
                 "AV-blokk/PM",
                 "Pulmonalvenestenose",
                 "Øsofagusfistel",
                 "Hjerteinfarkt eller iskemi",
                 "Perikarditt/perikardvæske",
                 "Død",
                 "Annen komplikasjon",
                 "Totalt"))

tab_kompl_pros_lokalt <- d_ablanor_nasjonalt %>% 
  dplyr::filter(centreid %in% params$reshId,
                komp_janei %in% 1)  %>% 
  mutate(komp_tekst = case_when(
    komp_av_fistel %in% 1 ~ "AV-fistel",
    komp_pseudoan %in% 1 ~ "Pseudoaneurisme",
    komp_blodning %in% 1 ~ "Blødning",
    komp_infek %in% 1 ~ "Infeksjon",
    komp_tamp %in% 1 ~ "Tamponade",
    komp_nfren %in% 1 ~ "N. frenicus parese",
    komp_apoplexi %in% 1 ~ "Apoplexi/TIA",
    komp_avblokk_pm %in% 1 ~ "AV-blokk/PM",
    komp_pulm %in% 1 ~ "Pulmonalvenestenose",
    komp_osofag %in% 1 ~ "Øsofagusfistel",
    komp_koronar %in% 1 ~ "Hjerteinfarkt eller iskemi",
    komp_perikard %in% 1 ~ "Perikarditt/perikardvæske",
    komp_dod %in% 1 ~ "Død",
    komp_annen %in% 1 ~ "Annen komplikasjon",
    .default = NA_character_
  )) %>% 
  count(komp_tekst) %>% 
  janitor::adorn_totals(name = "Totalt") %>%
  dplyr::rename("Komplikasjoner" = komp_tekst,
                "Antall fra pros" = n)


tab_kompl_hendelse_lokalt <- d_ablanor_hendelse_innen4dager_nasjonalt %>% 
  dplyr::filter(centreid %in% params$reshId,
                adhoc_komp_janei %in% 1)  %>% 
  mutate(komp_tekst = case_when(
    adhoc_komp_av_fistel %in% 1 ~ "AV-fistel",
    adhoc_komp_pseudoan %in% 1 ~ "Pseudoaneurisme",
    adhoc_komp_blodning %in% 1 ~ "Blødning",
    adhoc_komp_infek %in% 1 ~ "Infeksjon",
    adhoc_komp_tamp %in% 1 ~ "Tamponade",
    adhoc_komp_nfren %in% 1 ~ "N. frenicus parese",
    adhoc_komp_apoplexi %in% 1 ~ "Apoplexi/TIA",
    adhoc_komp_avblokk_pm %in% 1 ~ "AV-blokk/PM",
    adhoc_komp_pulm %in% 1 ~ "Pulmonalvenestenose",
    adhoc_komp_osofag %in% 1 ~ "Øsofagusfistel",
    adhoc_komp_koronar %in% 1 ~ "Hjerteinfarkt eller iskemi",
    adhoc_komp_perikard %in% 1 ~ "Perikarditt/perikardvæske",
    adhoc_komp_dod %in% 1 ~ "Død",
    adhoc_komp_annen %in% 1 ~ "Annen komplikasjon",
    .default = NA_character_
  )) %>% 
  count(komp_tekst) %>% 
  janitor::adorn_totals(name = "Totalt") %>%
  dplyr::rename("Komplikasjoner" = komp_tekst,
                "Antall fra hendelse" = n)


tab_komp_lokalt <- tab_komp %>% 
  dplyr::left_join(., tab_kompl_pros_lokalt, by = "Komplikasjoner") %>% 
  dplyr::left_join(., tab_kompl_hendelse_lokalt, by = "Komplikasjoner") %>% 
  janitor::adorn_totals("col", name = "Antall") %>% 
  select(Komplikasjoner, Antall)



tab_kompl_pros_nasjonalt <- d_ablanor_nasjonalt %>% 
  dplyr::filter(komp_janei %in% 1)  %>% 
  mutate(komp_tekst = case_when(
    komp_av_fistel %in% 1 ~ "AV-fistel",
    komp_pseudoan %in% 1 ~ "Pseudoaneurisme",
    komp_blodning %in% 1 ~ "Blødning",
    komp_infek %in% 1 ~ "Infeksjon",
    komp_tamp %in% 1 ~ "Tamponade",
    komp_nfren %in% 1 ~ "N. frenicus parese",
    komp_apoplexi %in% 1 ~ "Apoplexi/TIA",
    komp_avblokk_pm %in% 1 ~ "AV-blokk/PM",
    komp_pulm %in% 1 ~ "Pulmonalvenestenose",
    komp_osofag %in% 1 ~ "Øsofagusfistel",
    komp_koronar %in% 1 ~ "Hjerteinfarkt eller iskemi",
    komp_perikard %in% 1 ~ "Perikarditt/perikardvæske",
    komp_dod %in% 1 ~ "Død",
    komp_annen %in% 1 ~ "Annen komplikasjon",
    .default = NA_character_
  )) %>% 
  count(komp_tekst) %>% 
  janitor::adorn_totals(name = "Totalt") %>%
  dplyr::rename("Komplikasjoner" = komp_tekst,
                "Antall fra pros" = n)


tab_kompl_hendelse_nasjonalt <- d_ablanor_hendelse_innen4dager_nasjonalt %>% 
  dplyr::filter(adhoc_komp_janei %in% 1)  %>% 
  mutate(komp_tekst = case_when(
    adhoc_komp_av_fistel %in% 1 ~ "AV-fistel",
    adhoc_komp_pseudoan %in% 1 ~ "Pseudoaneurisme",
    adhoc_komp_blodning %in% 1 ~ "Blødning",
    adhoc_komp_infek %in% 1 ~ "Infeksjon",
    adhoc_komp_tamp %in% 1 ~ "Tamponade",
    adhoc_komp_nfren %in% 1 ~ "N. frenicus parese",
    adhoc_komp_apoplexi %in% 1 ~ "Apoplexi/TIA",
    adhoc_komp_avblokk_pm %in% 1 ~ "AV-blokk/PM",
    adhoc_komp_pulm %in% 1 ~ "Pulmonalvenestenose",
    adhoc_komp_osofag %in% 1 ~ "Øsofagusfistel",
    adhoc_komp_koronar %in% 1 ~ "Hjerteinfarkt eller iskemi",
    adhoc_komp_perikard %in% 1 ~ "Perikarditt/perikardvæske",
    adhoc_komp_dod %in% 1 ~ "Død",
    adhoc_komp_annen %in% 1 ~ "Annen komplikasjon",
    .default = NA_character_
  )) %>% 
  count(komp_tekst) %>% 
  janitor::adorn_totals(name = "Totalt") %>%
  dplyr::rename("Komplikasjoner" = komp_tekst,
                "Antall fra hendelse" = n)


tab_komp_nasjonalt <- tab_komp %>% 
  dplyr::left_join(., tab_kompl_pros_nasjonalt, by = "Komplikasjoner") %>% 
  dplyr::left_join(., tab_kompl_hendelse_nasjonalt, by = "Komplikasjoner") %>% 
  janitor::adorn_totals("col", name = "Nasjonalt") %>% 
  select(Komplikasjoner, Nasjonalt)


tab_komp_samlet <- tab_komp %>% 
  dplyr::left_join(., tab_komp_lokalt, by = "Komplikasjoner") %>% 
  dplyr::left_join(., tab_komp_nasjonalt, by = "Komplikasjoner")


tab_komp_samlet %>%   
  rapbase::mst(.,
               type = params$tableFormat,
               cap = cap,
               digs = 1,
               align = "lrr",
               fs = 9,
               lsd = FALSE)

```


<br>


```{r pagebreak3, results = "asis", eval = (params$tableFormat == "pdf")}
cat("\n\n\\pagebreak\n")
```



# Prosedyrevarighet
Forløp med manglende prosedyrevarighet (n = 
`r d_ablanor %>%  dplyr::filter(is.na(pros_varighet)) %>%  nrow()`) er fjernet
fra datagrunnlaget. 

Figur \@ref(fig:figProsedyreVarighetMin) viser et boxplot med fordeling av 
prosedyrevarighet per måned. Den blå boksen markerer nedre og øvre
kvartil, medianen er markert av den tykke linjen.
Punktene utenfor greinene viser uteliggere, det vil si 
forløp med usedvanlig kort eller lang prosedyrevarighet 
(prosedyrevarighet lengre enn 1,5 ganger interkvartil bredde over øvre kvartil/
under nedre kvartil).



```{r figProsedyreVarighetMin, fig.cap = fig.cap, fig.pos = "H", fig.align = 'center',  out.width = "80%", fig.asp = 0.8}

fig.cap <-  "Prosedyrevarighet i minutter per måned."

d_ablanor %>% 
  dplyr::filter(!is.na(.data$pros_varighet)) %>% 
  ggplot2::ggplot(ggplot2::aes(y = maaned, x = pros_varighet)) +
  ggplot2::geom_boxplot(fill = colPrimary[4]) +
  ablanor::ablanor_plot_theme() +
  ggplot2::scale_y_discrete(drop = FALSE) + 
  ggplot2::labs(title = paste0("Prosedyrevarighet (minutter) de ",
                               showN, " siste månedene"), 
                subtitle = hospitalNameShort) 

```





```{r pagebreak9, results = "asis", eval = (params$tableFormat == "pdf")}
cat("\n\n\\pagebreak\n")
```

# Røntgentid

Forløp med manglende røntgenvarighet (n = 
`r d_ablanor %>%  dplyr::filter(is.na(rtg_tid)) %>%  nrow()`) er fjernet
fra datagrunnlaget. 


Figur \@ref(fig:figRontgenVarighetMin) viser et boxplot med fordeling av 
røntgenvarighet per måned. Den blå boksen markerer nedre og øvre
kvartil, medianen er markert av den tykke linjen.
Punktene utenfor greinene viser uteliggere, det vil si 
forløp med usedvanlig kort eller lang prosedyrevarighet 
(prosedyrevarighet lengre enn 1,5 ganger interkvartil bredde over øvre kvartil/
under nedre kvartil).


Tabell \@ref(tab:tabellRontgenvarighet1) viser gjennomsnittlig røntgenvarighet
per måned, totalt og for hver av de fire forløpstypene.



```{r figRontgenVarighetMin, fig.cap = cap, fig.pos = "H", fig.align = 'center',  out.width = "100%", fig.asp = 0.8}
cap <- "Røntgentid i minutter per måned."

d_varighet_tot_maaned <- d_ablanor %>%
  dplyr::filter(!is.na(.data$rtg_tid)) %>% 
  dplyr::select("maaned", "rtg_tid") %>%
  dplyr::mutate(rtg_tid = as.numeric(.data$rtg_tid)) %>%
  dplyr::mutate(rtg_tid_min = .data$rtg_tid / 60)

d_varighet_tot_maaned %>% 
  ggplot2::ggplot(ggplot2::aes(y = maaned, x = rtg_tid_min)) +
  ggplot2::geom_boxplot(fill = colPrimary[4]) +
  ablanor::ablanor_plot_theme() +
  ggplot2::scale_y_discrete(drop = FALSE) + 
  ggplot2::labs(title = paste0("Røntgenvarighet (minutter) de ",
                               showN, " siste månedene"), 
                subtitle = hospitalNameShort) 

```


```{r tabellRontgenvarighetForberede}
# VARIGHET røntgen per måned TOTALT:
d_varighetRtg_mnd <- d_ablanor %>%
  dplyr::filter(!is.na(.data$rtg_tid)) %>% 
  dplyr::select("rtg_tid", "maaned") %>%
  dplyr::mutate(rtg_tid = as.numeric(.data$rtg_tid)) %>%
  dplyr::mutate(rtg_tid_min = .data$rtg_tid / 60) %>%
  dplyr::group_by(.data$maaned, .drop = FALSE) %>%
  dplyr::summarise(rtg_meanN = paste0(sprintf("%0.0f",
                                              mean(.data$rtg_tid_min)), 
                                      " [", sprintf("%0.0f", dplyr::n()), "]"),
                   .groups = 'drop') %>%
  dplyr::transmute(maaned = .data$maaned, Totalt = .data$rtg_meanN) 


# FORLØPSTYPE
d_varighetRtg_forlop <- d_ablanor %>%
  dplyr::filter(!is.na(.data$rtg_tid)) %>%
  dplyr::select("forlopstype", "rtg_tid", "maaned") %>%
  dplyr::group_by(.data$forlopstype, .data$maaned, .drop = FALSE) %>%
  dplyr::mutate(rtg_tid = as.numeric(.data$rtg_tid)) %>%
  dplyr::mutate(rtg_tid_min = .data$rtg_tid / 60) %>%
  dplyr::summarise(rtg_meanN = paste0(sprintf("%0.0f",
                                              mean(.data$rtg_tid_min)),
                                      " [",
                                      sprintf("%0.0f", dplyr::n()), "]"),
                   .groups = 'drop') %>%
  dplyr::mutate(rtg_meanN = dplyr::recode(.data$rtg_meanN, 
                                          "NaN [0]" = " -- ")) %>% 
  dplyr::ungroup() %>% 
  dplyr::rename(legend = .data$forlopstype, value = .data$rtg_meanN) %>%
  ablanor::leggTilTomme_PivotWide(., remove_NAcols = TRUE) %>% 
  dplyr::rename("AFLI"="1",
                "VT"="2", 
                "SVT"="3", 
                "EFU"="4")


d_varighetRtg_TOTAL<- dplyr::full_join(d_varighetRtg_mnd,
                                       d_varighetRtg_forlop,
                                       by = "maaned") %>% 
  dplyr::arrange(desc(.data$maaned))
```


```{r tabellRontgenvarighet1}
cap <- paste0("Gjennomsnittlig røntgenvarighet i minutter de ", 
              showN, " siste månedene. ",
              "Totalt og for hver forløpstype. ", 
              "Gjennomsnitt [antall].")

knitr::kable(
  x = d_varighetRtg_TOTAL,
  format = switch(params$tableFormat,
                  pdf = "latex",
                  html = "html"),
  align = c("l", rep("c", 5)),
  caption = cap,
  booktabs = TRUE) %>%
  kableExtra::add_header_above(c(" " = 1,
                                 " " = 1,
                                 "Forløpstype" = 4)) %>%
  gsub("maaned", "Måned", .) %>%
  ablanor::mst_short(., type = params$tableFormat,
                     lsd = FALSE, 
                     fs = 8, 
                     full_width = FALSE)
```


