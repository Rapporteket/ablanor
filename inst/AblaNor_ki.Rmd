---
params:
  title: tom tittel
  author: ukjent forfatter
  hospitalName: ukjent sykehus
  tableFormat: html
  reshId: 999999
  registryName: rapbase
  userFullName: Tore Tester
  userRole: ukjent rolle
  userOperator: ukjent operatør
title: Nasjonalt register for ablasjonsbehandling og elektrofysiologi i Norge (AblaNor)
abstract: '`r paste0("Denne rapporten er generert ved hjelp av resultatløsningen _Rapporteket_ og sendes ut per e-post til personer i fagmiljøet som på forhånd har bestilt denne tjenesten. Rapporten er kun ment til internt bruk! Rapporten inneholder tabeller og figurer med resultater basert på forløp registrert ved ", params$hospitalName, " sammenlignet med nasjonale tall. Opptellinger og statistikker er gjort per forløp/prosedyre, og ikke per individ.")`'
date: '`r format(Sys.time(), "%d. %B, %Y")`'
registryName: '`r params$registryName`'
reglogo: '`r system.file("logoAblanor.png", package = "ablanor")`'
regtext: '`r readLines(system.file("registryShortDescription.txt", package = "ablanor"))`'
userFullName: '`r params$userFullName`'
output:
  fig_caption: yes
---


```{r knitrOptions, include=FALSE}
library(ablanor)
library(magrittr)
library(knitr)
library(dplyr)
library(ggplot2)

# make sure to use a temporary directory AND absolute paths, e.g. that figs
# can be found also when deployed at a server. See below link for explanation
# https://rgriff23.github.io/2017/04/25/how-to-knit-for-mysite.html
# Also make sure we use tempdir() as working directory so we do not clutter
# the package of the hosting shiny app
# workDir <- tempdir()
# knitr::opts_knit$set(base.dir=workDir, base.url=file.path(paste0(tempdir(), "/")), root.dir = workDir)

# Handle both html and latex (pdf) output. Actually to avoid setting 'format'
# for each kable call
# inspired by https://stackoverflow.com/questions/46080853/why-does-rendering-a-pdf-from-rmarkdown-require-closing-rstudio-between-renders
options(knitr.table.format = params$tableFormat)
knitr::opts_chunk$set(warnings = FALSE, echo = FALSE)
options(stringsAsFactors = FALSE)

# For some reason Shiny Server does not get the server locale settings right.
# To display dates correct, enforce locale here:
Sys.setlocale("LC_TIME", "nb_NO.UTF-8")
``` 




```{r SKDEcol, include=FALSE}
colPrimary <- c("#000059", "#084594", "#2171b5", "#4292c6", "#6baed6", "#c6dbef")
colNeutral <- c("#4D4D4D", "#737373", "#A6A6A6", "#DADADA")
colKontrast <- "#FF7260"
```
  
  
```{r latest_entry, include=FALSE, eval=TRUE}

# 1) DATAGRUNNLAG: PERIODE FOR SQL SPØRRING

# NYESTE DATO: 
# Finne nyeste prosedyredato (=nyeste registrering). Vi ønsker ikke at 
# forhåndsregisrerte planlagte forløp kommer med i rapporten. Derfor brukes
# gårsdagens dato som referanse, ingen forløp etter denne kommer med.  
# Vi vil dermed også kunne se dersom ingen nye registreringer gjøres eller om
# overføringer har stoppet opp
# I rapporten bruker vi kun hele (komplette = fullførte måneder)


periode_data <- data.frame(
  
  # Nyeste registrering eller gårsdagen (ikke forhåndsregistreringer)
  nyeste_reg = min(
    (as.Date(Sys.time()) - 1), 
    ablanor::getLatestEntry(registryName = params$registryName))) %>% 
  
  dplyr::mutate(
    
    # SISTE DATO AVGJØR SISTE MÅNED: 
    siste_dato_innevarende_mnd = lubridate::ceiling_date(
      x = nyeste_reg, 
      unit =  "month") - lubridate::days(1),
    
    siste_dato = dplyr::case_when(
      # siste dato er nyeste dato --> nyeste mnd er komlett
      siste_dato_innevarende_mnd == nyeste_reg ~ 
        nyeste_reg, 
      
      # siste dato er ikke nyeste --> nyest mnd er ikke komplett, ta forrige
      siste_dato_innevarende_mnd != nyeste_reg ~ 
        lubridate::floor_date(nyeste_reg, "month") - 
        lubridate::days(1), 
      
      TRUE ~ as.Date(NA_character_)),
    
    # Inneværende år: 
    nyesteRegYear = as.numeric(format(siste_dato, format = "%Y")),
    
    # Fjoråret
    sisteHeleYear = nyesteRegYear - 1, 
    
    # Første dato for SQL -spørring : 01. januar fjoråret
    forste_dato  = as.Date(paste0(sisteHeleYear, "-01-01"),
                           format = "%Y-%m-%d") 
  )


```


```{r GetData}
# NASJONALE DATA (SC-ROLLE)
d_ablanor <- ablanor::getBaseregProsData(registryName = params$registryName, 
                                         singleRow = FALSE,
                                         reshId = NULL,
                                         userRole = "SC",
                                         fromDate = periode_data$forste_dato,
                                         toDate = periode_data$siste_dato) %>% 
  dplyr::mutate(aar = aar_prosedyre, 
                maaned = maaned_prosedyre, 
                maaned_nr = maaned_nr_prosedyre) %>% 
  dplyr::filter(forlopstype %in% 1:4)
```

```{r forste_siste_registrering_SHUS}

periode_data$forste_dato_shus <- d_ablanor %>% 
  dplyr::filter(centreid == params$reshId) %>% 
  dplyr::summarise(min(dato_pros)) %>% 
  dplyr::pull()

periode_data$nyeste_dato_shus <- d_ablanor %>% 
  dplyr::filter(centreid == params$reshId) %>% 
  dplyr::summarise(max(dato_pros)) %>% 
  dplyr::pull()
```


```{r monthTabPrepare, include=FALSE, eval=TRUE}

timeTableMonth <- data.frame(
  monthDato = seq(periode_data$forste_dato, 
                  periode_data$siste_dato,
                  by = "month")) %>% 
  dplyr::transmute(maaned = as.factor(format(x = monthDato, 
                                             format = "%Y-%m"))) %>% 
  dplyr::mutate(maaned = as.ordered(maaned))

timeTableMonth_fjor <- data.frame(
  monthDato = seq(periode_data$forste_dato, 
                  as.Date(paste("31-12-", periode_data$sisteHeleYear), 
                          format = "%d-%m-%Y"),
                  by = "month")) %>% 
  dplyr::transmute(maaned = as.factor(format(x = monthDato, 
                                             format = "%Y-%m"))) %>% 
  dplyr::transmute(
    maaned = as.ordered(maaned))

timeTableMonth_aar <- data.frame(
  monthDato = seq(as.Date(paste("01-01-", periode_data$nyesteRegYear), 
                          format = "%d-%m-%Y"),
                  periode_data$siste_dato,
                  by = "month")) %>% 
  dplyr::transmute(maaned = as.factor(format(x = monthDato, 
                                             format = "%Y-%m"))) %>% 
    dplyr::transmute(
      maaned = as.ordered(maaned))
rangeProsDato <- paste(format(periode_data$forste_dato, 
                              "%d/%m-%Y"), 
                       "til", 
                       format(periode_data$siste_dato, 
                              "%d/%m-%Y"))
siste_dato_txt <- format(x = periode_data$siste_dato,
                        format = "%d/%m-%Y")
```
  
  
  
```{r Oppdatere_levels}

# OPPDATERE ALLE ANDRE FAKTOR variabler, for å få med alle mulige nivåer
d_ablanor %<>%
  dplyr::mutate(forlopstype = factor(x = forlopstype,
                                     levels = 1:4))


lokaltSykehus <- ablanor::legg_til_sykehusnavn(
  data.frame(centreid = params$reshId), 
  short = TRUE)  %>% 
  dplyr::pull(sykehusnavn)

```
\bigskip \bigskip \bigskip


# Datagrunnlag
Rapporten er generert med utgangspunkt i AblaNor sin nasjonale database. 
Datasettet som ligger til grunn har nasjonale data fra 
`r d_ablanor %>% dplyr::select(centreid) %>% dplyr::distinct() %>% nrow()` 
sykehus og nyeste registrering nasjonalt er datert 
`r format(periode_data$nyeste_reg, '%d. %B %Y')`. Det presenteres månedlige
resultater for hele fjorårets produksjon, samt alle
fullførte måndeder hittil i år.  
Den siste prosedyredatoen som er med i tabellene og 
figurene er dermed `r format(periode_data$siste_dato, '%d. %B %Y')`. 


I rapporten sammenlignes resultater fra fra `r params$hospitalName` med 
nasjonale tall.  Første og siste registrering fra `r params$hospitalName` 
i tidsperioden er henholdsvis
`r format(periode_data$forste_dato_shus, "%d/%m-%Y") ` og
`r format(periode_data$nyeste_dato_shus, "%d/%m-%Y") `. 

  
  
  
  
  
  
  
  
```{r pagebreak1, results = "asis", eval = (params$tableFormat == "pdf")}
cat("\n\n\\pagebreak\n")
```


\bigskip \bigskip \bigskip


# Forløpstype
Forløpene i registrert i AblaNor er en av typene : Atrieflimmer/atypisk flutter
(AFLI), Ventrikkeltakykardi (VT), Supraventrikulær takykardi (SVT) eller 
Elektrofysiologisk undersøkelse (EFU). 
Tabellen under (Tabell \@ref(tab:typeForlopAar)) viser antall forløp
registrert i AblaNor nasjonalt og kun fra `r params$hospitalName` 
for hele fjoråret sammenlignet med hittil i år. 
for hver forløpstype og sammenlagt. 

  
  
```{r typeForlopAar}
cap <- paste("Antall registrerte prosedyrer fra ",
             periode_data$sisteHeleYear, 
             "og hittil i år (t.o.m ",
             siste_dato_txt, "). For ",
             params$hospitalName, " og nasjonalt, ",
             "samt for hver av de 4 forløpstypene: ",
             "Atrieflimmer/atypisk flutter (AFLI), Ventrikkeltakykardi (VT), ", 
             "Supraventrikulær takykardi (SVT) eller ", 
             "Elektrofysiologisk undersøkelse (EFU).")


myHeader <- c("", lokaltSykehus = 2, "Nasjonalt" = 2)
names(myHeader) <-  c("", lokaltSykehus, "Nasjonalt" )

tab_forlop_lokalt <- d_ablanor %>%
  dplyr::filter(centreid %in% params$reshId) %>% 
  dplyr::count(forlopstype, aar) %>% 
  ablanor::legg_til_forlopstype_kortnavn(., 
                                         total  = FALSE, 
                                         langtnavn = FALSE) %>% 
  dplyr::mutate(name = paste0(aar,"_", lokaltSykehus)) %>% 
  dplyr::select(-aar, -forlopstype) %>% 
  tidyr::pivot_wider(names_from = name,
                     values_from = n,
                     values_fill = 0)

tab_forlop_nasj <- d_ablanor %>%
  dplyr::count(forlopstype, aar) %>% 
  ablanor::legg_til_forlopstype_kortnavn(., 
                                         total  = FALSE, 
                                         langtnavn = FALSE) %>% 
  dplyr::mutate(name = paste0(aar,"_nasjonalt")) %>% 
  dplyr::select(-aar, -forlopstype) %>% 
  tidyr::pivot_wider(names_from = name,
                     values_from = n,
                     values_fill = 0)

tab_forlop <- dplyr::right_join(
  tab_forlop_lokalt, 
  tab_forlop_nasj,
  by = "forlopstype_tekst") %>% 
  janitor::adorn_totals("row", name = "Totalt") 

tab_forlop %>% 
  rapbase::mst(.,
               type = params$tableFormat,
               col_names = c("Forløpstype",
                             periode_data$sisteHeleYear,
                             periode_data$nyesteRegYear,
                             periode_data$sisteHeleYear,
                             periode_data$nyesteRegYear),
               cap = cap,
               digs = 1,
               align = "lrrrr",
               fs = 9, 
               lsd = FALSE) %>% 
  kableExtra::add_header_above(header = myHeader)
```


## Kumulert antall prosedyrer per år
```{r FigKumulertProde, fig.cap =  paste0("Kumulert antall prosedyrer i AblaNor, nasjonalt og ved ", params$hospitalName, " for hele fjoråret og hittil i år (t.o.m ", siste_dato_txt , ")."), fig.width = 8, fig.height = 5,  fig.pos = "H", fig.align = "center", out.width = "\\textwidth"}

df_cumplot_nasj <- d_ablanor %>%
  dplyr::select(maaned_nr, aar) %>% 
  dplyr::count(maaned_nr, aar) %>% 
  dplyr::arrange(maaned_nr) %>% 
  dplyr::group_by(aar) %>% 
  dplyr::mutate(
    Total = cumsum(n), 
    Maaned = factor(maaned_nr, 
                    levels = c("01", "02", "03", "04", "05", "06", "07", 
                               "08", "09", "10", "11", "12"),
                    labels = c("Jan", "Feb", "Mars", "April", "Mai", 
                               "Juni", "Juli", "Aug", "Sept", "Okt", 
                               "Nov", "Des")),
    max_tota = max(Total, na.rm = TRUE),
    
    Label = ifelse(Total == max_tota, 
                   max_tota, 
                   NA_character_), 
    sykehus = "Nasjonalt")
 
df_cumplot_lokalt <- d_ablanor %>%
  dplyr::filter(centreid %in% params$reshId) %>% 
  dplyr::select(maaned_nr, aar) %>% 
  dplyr::count(maaned_nr, aar) %>% 
  dplyr::arrange(maaned_nr) %>% 
  dplyr::group_by(aar) %>% 
  dplyr::mutate(
    Total = cumsum(n), 
    Maaned = factor(maaned_nr, 
                    levels = c("01", "02", "03", "04", "05", "06", "07", 
                               "08", "09", "10", "11", "12"),
                    labels = c("Jan", "Feb", "Mars", "April", "Mai", 
                               "Juni", "Juli", "Aug", "Sept", "Okt", 
                               "Nov", "Des")),
    max_tota = max(Total, na.rm = TRUE),
    
    Label = ifelse(Total == max_tota, 
                   max_tota, 
                   NA_character_), 
    sykehus = lokaltSykehus)
  
  
tot_fjor_n <- df_cumplot %>% 
  dplyr::filter(aar == periode_data$sisteHeleYear, 
                sykehus == "Nasjonalt") %>% 
  dplyr::pull(Total) %>%
  max(., na.rm = TRUE)

tot_fjor_l <- df_cumplot %>% 
  dplyr::filter(aar == periode_data$sisteHeleYear ,
                sykehus == lokaltSykehus) %>% 
  dplyr::pull(Total) %>% 
  max(., na.rm = TRUE)


df_cumplot <- bind_rows(
  df_cumplot_nasj, 
  df_cumplot_lokalt) %>% 
  dplyr::mutate(group = paste(sykehus, aar))

ggplot2::ggplot(df_cumplot) +
    ggplot2::geom_line(
        mapping = ggplot2::aes(x = Maaned, 
                               y = Total, 
                               group = group, 
                               colour = aar), 
        linewidth = 1.5, 
        alpha = 0.6) + 
    ggplot2::scale_color_manual(
        name = "",
        values = c(colPrimary[3],  colKontrast), 
        labels = 2022:2023, 
        breaks = 2022:2023)+
    ggplot2::geom_label(mapping = ggplot2::aes(x= 10,
                                               y = tot_fjor_l*1.1 ,
                                               label = lokaltSykehus) ,
                        colour = colPrimary[3]) +
    ggplot2::geom_label(mapping = ggplot2::aes(x= 10,
                                               y = tot_fjor_n*0.95,
                                               label = "Nasjonalt"),
                        colour = colPrimary[3])+
    ggplot2::xlab("") + 
    ggplot2::ylab("Kumulert antall prosedyrer") + 
    ggplot2::theme_minimal() + 
    ggplot2::theme(legend.title = ggplot2::element_blank(),
                   axis.text = ggplot2::element_text(size = 12),
                   axis.title = ggplot2::element_text(size = 12), 
                   legend.text = ggplot2::element_text(size = 12), 
                   legend.position = "top")

```


```{r pagebreak2, results = "asis", eval = (params$tableFormat == "pdf")}
cat("\n\n\\pagebreak\n")
```


# Komplikasjoner
I Ablanor registreres følgende: "Skjedde det komplikasjoner som følge av
operasjonen?". Dette kan enten være komplikasjoner som oppstod umiddelbart
etter operasjonen eller som var senkomplikasjoner som (sannsynligvis) skyldtes
operasjonen.

Figur \@ref(fig:komplikasjonerFig) viser prosentandel forløp der komplikasjoner
skjedde, per måned. Tallene i søylen viser antall forløp med komplikasjoner,
delt på på totalt antall forløp den måneden. Tabell
\@ref(tab:komplikasjonerMaanedTabell) viser andel forløp med komplikasjoner
totalt per måned og i underpopulasjoner per måned.





```{r pagebreak3, results = "asis", eval = (params$tableFormat == "pdf")}
cat("\n\n\\pagebreak\n")
```


# Akutt suksess
Akutt suksess er operatørens vurdering av om selve operasjonen er vellykket: 
"Nei" dersom behandlet arytmi fortsatt er tilstede,  "Ja" dersom 
PV isolert/AP borte/ikke utløsbar arytmi. "Usikker" dersom sett andre arytmier 
fortsatt, men mindre arytmi og "Ikke aktuelt" dersom ikke utløst arytmi. 

Elektrofysiologiske undersøkelse eller forløp der akutt suksess er lik
"Ikke aktuelt" er fjernet fra datagrunnlaget. 

Andel forløp med akutt suksess er regnet ut ved å dele antall forløp der akutt suksess er lik "Ja" på totalt 
antall forløp der akutt suksess er en av "Ja", "Nei" eller "Usikker". 
Figur \@ref(fig:akuttSuksessFig) viser prosentandel forløp med akutt suksess
blant abladerte, per måned. Tabell \@ref(tab:akuttSuksessMaaned) viser andel
forløp med akutt suksess blant abladerte totalt og i underpopulasjoner, per
måned.
MERK: SJEKK OM FÅ VT

```{r akuttSuksess, fig.cap = figtekst, fig.pos = "H", fig.align = "center", out.width = "100%", fig.asp = 1.2}

figtekst <- paste0("Måloppnåelse for akutt suksess for", 
                   params$hospitalName, 
                   "og nasjonalt hver måned det siste året. ", 
                   "For forløpstypene Atrieflimmer (AFLI), ", 
                   "Ventrikkeltakykardi (VT), ", 
                   "AV nodal reentry (SVT‑AVNRT) og ", 
                   "Aksessoriske baner (SVT‑AVRT). ", 
                   "Målnivåene vises i farger. ")




akutt_suksess_lokalt_afli <- d_ablanor %>% 
 dplyr::select(centreid, 
               maaned, 
               indik_akuttsuksess_data, 
               indik_akuttsuksess) %>% 
 dplyr::filter(centreid == params$reshId, 
               !indik_akuttsuksess_data %in% "nei", 
               indik_akuttsuksess %in% c("ja", "nei")) %>% 
 dplyr::count(indik_akuttsuksess_data, 
              indik_akuttsuksess, 
              maaned) %>% 
 tidyr::pivot_wider(names_from = indik_akuttsuksess, 
                    values_from = n, 
                    values_fill = 0) %>% 
 mutate(prosent = ja/(ja+nei), 
        sykehusnavn = params$hospitalName)
           

akutt_suksess_nasjonalt_afli <- d_ablanor %>% 
 dplyr::select(maaned, 
               indik_akuttsuksess_data, 
               indik_akuttsuksess) %>% 
dplyr::filter(!indik_akuttsuksess_data %in% "nei", 
              indik_akuttsuksess %in% c("ja", "nei")) %>% 
 dplyr::count(indik_akuttsuksess_data, 
              indik_akuttsuksess, 
              maaned) %>% 
 tidyr::pivot_wider(names_from = indik_akuttsuksess, 
                    values_from = n, 
                    values_fill = 0) %>% 
 mutate(prosent = ja/(ja+nei), 
        sykehusnavn = "Nasjonalt")


d_akuttS <- dplyr::bind_rows(
                  akutt_suksess_lokalt_afli,
                  akutt_suksess_nasjonalt_afli)

farger_trafikklys <- c("#FF0000", "#009900") 

    
p1 <- ggplot2::ggplot()

p1 <- p1 +
 
    ggplot2::geom_line(data = d_akuttS,
                        aes(x = maaned,
                            y = prosent,
                            group = sykehusnavn, 
                            linetype = sykehusnavn)) +
  
    ggplot2::facet_wrap(vars(indik_akuttsuksess_data), ncol = 1)+
    ggplot2::coord_cartesian(ylim = c(0, 1)) +
    ggplot2::guides(col = guide_legend(ncol=1))+
    ggplot2::scale_y_continuous(
      name = "",
      breaks = seq(from = 0,
                   to = 1,
                   length.out = 6),
      labels = paste0(seq(from = 0,
                          to = 1,
                          length.out = 6) * 100, "%")) +

     ggplot2::scale_x_discrete(name = "") 

p1 <- p1 +
      ggplot2::geom_rect(data = data.frame(indik_akuttsuksess_data = "AFLI"),
                         xmin=-Inf, xmax=Inf, ymin=0.9, ymax=Inf,
                        alpha =0.2,
                        fill = farger_trafikklys[2]) +
      ggplot2::geom_rect(data = data.frame(indik_akuttsuksess_data = "AFLI"),
                        xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=0.9,
                        alpha =0.2,
                        fill = farger_trafikklys[1]) + 
 
      ggplot2::geom_rect(data = data.frame(indik_akuttsuksess_data = "VT"),
                         xmin=-Inf, xmax=Inf, ymin=0.7, ymax=Inf,
                        alpha =0.2,
                        fill = farger_trafikklys[2]) +
      ggplot2::geom_rect(data = data.frame(indik_akuttsuksess_data = "VT"),
                        xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=0.7,
                        alpha =0.2,
                        fill = farger_trafikklys[1]) +
  
      ggplot2::geom_rect(data = data.frame(indik_akuttsuksess_data = c("AVNRT", "AVRT")),
                         xmin=-Inf, xmax=Inf, ymin=0.95, ymax=Inf,
                        alpha =0.2,
                        fill = farger_trafikklys[2]) +
      ggplot2::geom_rect(data = data.frame(indik_akuttsuksess_data = c("AVNRT", "AVRT")),
                        xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=0.95,
                        alpha =0.2,
                        fill = farger_trafikklys[1]) 
    
  
p1 <- p1 + 
   ggplot2::theme(
    legend.position = "bottom",
    legend.text.align = 0,
    legend.background = ggplot2::element_blank(),
    legend.title = ggplot2::element_blank(),
    legend.key = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(family = "sans",
                                        size = 12,
                                        color = "#222222"),
    # Axis format
    axis.title.x = ggplot2::element_blank(),
    axis.title.y = ggplot2::element_text(family = "sans",
                                         size = 12,
                                         color = "#222222"), 
    axis.text.y = ggplot2::element_text(family = "sans",
                                        size = 12,
                                        color = "#222222"),
    axis.text.x = ggplot2::element_text(family = "sans",
                                        angle=45, 
                                        vjust =1, 
                                        hjust=1, 
                                        size = 12,
                                        color = "#222222")
  )
 


p1


```

  
```{r pagebreak4, results = "asis", eval = (params$tableFormat == "pdf")}
cat("\n\n\\pagebreak\n")
```

